---
# Horizontal Pod Autoscaler for API
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-hpa
  namespace: aegispcap
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: aegispcap-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80

---
# Horizontal Pod Autoscaler for Frontend
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: frontend-hpa
  namespace: aegispcap
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: aegispcap-frontend
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 75

---
# Network Policy (optional - restrict traffic)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: aegispcap-network-policy
  namespace: aegispcap
spec:
  podSelector:
    matchLabels:
      app: aegispcap-api
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: aegispcap-frontend
    ports:
    - protocol: TCP
      port: 8000
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# Service Monitor for Prometheus (optional)
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: aegispcap
data:
  prometheus-rules.yaml: |
    groups:
    - name: aegispcap
      interval: 30s
      rules:
      - alert: APIHighErrorRate
        expr: rate(api_errors_total[5m]) > 0.05
        for: 5m
        annotations:
          summary: "High error rate in API"
      - alert: APIHighLatency
        expr: histogram_quantile(0.95, api_request_duration_seconds_bucket) > 1
        for: 5m
        annotations:
          summary: "High latency detected"
      - alert: PodMemoryUsage
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.85
        for: 5m
        annotations:
          summary: "High memory usage"
